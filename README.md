 Лабораторная работа №3.
Ресурсы Windows-приложений, создание и подключение ресурса меню, акселераторы, динамическое создание и изменение меню, взломщики сообщений и макро HANDLE_MSG.
.

Задание.1 Научиться создавать и использовать ресурсы типа "значок", "курсор", "меню" и "таблица акселераторов".

Задача. Создать приложение с главным окном, своим значком, своим изображением курсора и собственной обработкой сообщений WM_CREATE, WM_DESTROY, WM_PAINT, WM_LBUTTONDOWN (взять из предыдущего проекта).

Выполнение

1.	Создайте проект с исходными файлами предыдущего проекта. Для этого создайте пустой проект типа Win32 API c именем SP_PR3. С помощью файлового менеджера в папку проекта скопируйте файлы исходных текстов(.cpp) и заголовочные файлы(.h) из проекта предыдущей лабораторной работы SP_PR2 . Переименуйте скопированные файлы в sp_pr3.cpp и sp_pr3.h. Добавьте файлы к проекту. Выполните компиляцию и компоновку. Убедитесь в работоспособности полученной программы.

2.	Добавьте к проекту новый файл - файл описания ресурсов sp_pr3.rc . Для этого (см. презентацию SP_1-3d).

3.	Создайте ресурс типа значок (см презентацию SP_1-3d). В окне редактора значков сформируйте изображение значка размером 32х32.

4.	Внесите изменения в программу для использования созданного ресурса в качестве значка приложения.
Для этого необходимо значение дескриптора значка присвоить полю hIcon
структуры WNDCLASSEX. Сделать это можно, например, так

wc.hIcon = LoadIcon( hInstance, MAKEINTRESOURCE(IDI_ICON1));

Первый параметр функции LoadIcon указывает на местонахождение ресурса. В нашем случае это собственно исполнимый файл приложения и ссылкой на него служит дескриптор, передаваемый в первом параметре функции WinMain.
Второй параметр LoadIcon идентифицирует сам ресурс.

Создав и запустив на выполнение программу можно увидеть значок в левом вернем углу окна приложения и внизу на панели задач. Размер этих изображений 16х16 и они формируются Windows из стандартного изображения (32х32).

5.	Возвратившись в среду разработки и открыв снова редактор значков добавьте к ресурсу IDC_ICON1 изображения малого (16х16) и большого (48х48) значков. Сделайте все три изображения разными.
 
После переформирования и запуска приложения можно увидеть все три изображения. Малый значок, как и раньше – слева вверху и на панели задач. Стандартный (32х32) и большой (48х48) значки можно увидеть, если посмотреть в проводнике содержимое папки Debug (или Release) Вашего проекта
в режимах просмотра "Значки" и "Плитка".

6.	(Дополнительно, т.е. после занятия) Создайте ресурс типа курсор. Используйте созданный ресурс для класса окон приложения (значение дескриптора курсора присвойте полю hCursor структуры WNDCLASSEX).

Задание2. Научиться создавать и использовать ресурсы типа "меню" и "таблица акселераторов".

Задача. В приложение, полученное в результате выполнения Задания1, добавить меню, обработку WM_COMMAND для меню и клавиши быстрого доступа
(акселераторы).

Выполнение

7.	Создание меню.
Создайте ресурс меню следующего вида:
Главное меню содержит подменю “Файл”, “Правка”, “Справка”.
Подменю “Файл” содержит команды “Создать”, “Открыть”, “Выход”. Последняя команда отделена от других «разделителем».
Подменю “Правка” содержит команды “Выделить”, “Вырезать”, “Копировать”, “Вставить”. Команды этого меню установить в состояние «недоступные».
Подменю “Справка” содержит команды “Помощь”, “О программе…”.

Не забывайте для каждой команды меню указать на вкладке свойств идентификатор. Его символьное обозначение формируйте по шаблону IDM_<имя подменю>_<имя команды>. Например, IDM_FILE_NEW, IDM_EDIT_COPY и т.п.

Примечание. При формировании шаблона меню предусмотрите для каждой команды ввод строки-подсказки (на вкладке свойств), что приведет к автоматическому созданию ресурса типа таблица строк. Строки подсказок в этом ресурсе будут иметь идентификаторы, совпадающие с идентификаторами соответствующих команд меню.

8.	Подключение меню. a).
Подключите меню к программе через структуру класса окна. Для этого присвойте полю lpszMenuName структуры WNDCLASSEX значение указателя на имя меню. Так как имя меню определено как целочисленный идентификатор (например, IDR_MENU1), то примените макро MAKEINTRESOURCE для получения значения, присваиваемого полю lpszMenuName. Проверьте работу приложения.

б).
Подключите меню к программе через функцию создания окна CreateWindowEx:
меню сначала загружается при помощи функции LoadMenu:
HMENU hMenu = LoadMenu(HINSTANCE hlnstance, LPCTSTR IpMenuName).
 
Затем дескриптор меню hMenu, возвращаемый функцией LoadMenu, передается функции CreateWindowEx через параметр hMenu. Проверьте работу приложения.

9.	Добавление обработки сообщений меню.
Добавьте в оконную процедуру главного окна блок case для обработки сообщения WM_COMMAND (если его еще там нет). Внутри блока обработчика WM_COMMAND предусмотрите оператор switch для ветвления по идентификатору команды меню (младшее слово wParam — LOWORD(wParam)). Для каждой команды меню предусмотрите вывод сообщения “Выбрана команда XXX”, где ХХХ – наименование команды. Сообщение выводите с помощью системного вызова MessageBox. Для ветви default оператора switch предусмотрите вывод сообщения “Команда с идентификатором ZZZ не реализована”, где ZZZ – код идентификатора, для которого в WM_COMMAND не предусмотрен блок case (значение младшего слова wParam).

Пример:

...
case WM_COMMAND:
{...
int id=LOWORD(wParam); switch (id)
{
case IDM_FILE_OPEN:
MessageBox(hWnd, "Выбран пункт 'Open'", "Меню File". MB_0K);
break;
case IDM_FILE_CL0SE:
MessageBox(hWnd, "Выбран пункт 'Close'", "Меню File", MB_0K):
break:
case IDM_FILE_SAVE:
MessageBox(hWnd. "Выбран пункт 'Save'", "Меню File". MB_0K);
...
case IDM_FILE_EXIT:
DestroyWindow(hWnd); //SendMessage(hWnd, WM_DESTROY, 0, 0);
...
}
break;
...

10.	Создание акселераторов.
Добавьте в приложение несколько, на Ваш выбор, сочетаний клавиш быстрого доступа (акселераторов) и обеспечьте их обработку. Таблицу акселераторов создайте в виде ресурса приложения.

Пример:

...
HACCEL hAccel; hAccel=LoadAccelerators(hInstance,
 
MAKEINTRESOURCE(IDR_ACCELERATOR1);
...
while( GetMessage( &msg, NULL, 0, 0 ) )
{
if (!TranslateAccelerator(hWnd, hAccel, &msg))
{
TranslateMessage( &msg); DispatchMessage( &msg );
}
}
...

11.	Вывод подсказок о назначении команд.
Используя, сформированный вместе с шаблоном меню, ресурс типа таблица строк с текстом подсказок для элементов меню обеспечьте вывод подсказок в главном окне при выделении команд меню (сообщение WM_MENUSELECT). Текст подсказки располагать на 30 пикселей выше нижней границы окна. Положение нижней границы можно определить с помощью вызова GetClientRect.

Пример:

case WM_MENUSELECT:
{HDC hdc1; lpszMsgSpace=TEXT("ШШШШШШШШШШШШШШШШШШШШШШШШШШ"); TCHAR Buf[300];
HINSTANCE hInst;
hInst=(HINSTANCE)GetWindowLong(hWnd,GWL_HINSTANCE); int size; size=LoadString(hInst,LOWORD(wParam),Buf,300); hdc1= GetDC(hWnd);
RECT rc;
GetClientRect (hWnd,&rc);

TextOut(hdc1, rc.left+10,r c.bottom-30,
lpszMsgSpace,lstrlen(lpszMsgSpace));

TextOut(hdc1,rc.left+10,rc.bottom- 30,Buf,lstrlen(Buf));
ReleaseDC(hWnd, hdc1); break;
}
 
Задание 3. Динамическое создание и управление меню
 Операции с меню
1.	При инициализации приложения (в обработчике WM_CREATE) обеспечить вставку программным путем команды “Закрыть документ” в меню “Файл” .
2.	Обеспечить обработку при которой после активации команды “Файл -> Создать”
будет становиться доступной команда “Выделить” в меню “Правка”
3.	Обеспечить после ввода команды “Правка -> Выделить” доступность команды
“Правка -> Копировать” .
4.	После ввода команды “Файл-> Закрыть документ” делать недоступными все команды меню “Правка”.

Контекстное меню

По щелчку правой кнопки мыши в главном окне создать плавающее меню с командами “Выделить” и “Копировать”. Состояние этих команд должно соответствовать состоянию таких же команд в основном меню. Состояние команд меню определять вызывая GetMenuItemInfo либо GetMenuItemState (старый вариант). Во втором случае нужно обратить внимание на обработку возвращаемых флагов (см. MSDN).


